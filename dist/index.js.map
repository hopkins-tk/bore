{"version":3,"file":null,"sources":["../src/index.js"],"sourcesContent":["const { DocumentFragment, Node, Promise } = window;\nconst { slice } = [];\n\nfunction startsWith (key, val) {\n  return key.indexOf(val) === 0;\n}\n\nfunction shouldBeAttr (key, val) {\n  return startsWith(key, 'aria-') || startsWith(key, 'data-');\n}\n\nfunction handleFunction (Fn) {\n  return Fn.prototype instanceof HTMLElement ? new Fn() : Fn();\n}\n\nexport function h (name, attrs, ...chren) {\n  const node = typeof name === 'function' ? handleFunction(name) : document.createElement(name);\n  Object.keys(attrs || []).forEach(attr =>\n    shouldBeAttr(attr, attrs[attr])\n      ? node.setAttribute(attr, attrs[attr])\n      : (node[attr] = attrs[attr]));\n  chren.forEach(child => node.appendChild(child instanceof Node ? child : document.createTextNode(child)));\n  return node;\n}\n\nconst { customElements, HTMLElement, NodeFilter } = window;\nconst { body } = document;\nconst { attachShadow } = HTMLElement.prototype;\nconst { diff } = require('skatejs-dom-diff').default;\n\n// Ensure we can force sync operations in the polyfill.\nif (customElements) {\n  customElements.enableFlush = true;\n}\n\n// Create and add a fixture to append nodes to.\nconst fixture = document.createElement('div');\ndocument.body.appendChild(fixture);\n\n// Override to force mode \"open\" so we can query against all shadow roots.\nHTMLElement.prototype.attachShadow = function () {\n  return attachShadow.call(this, { mode: 'open' });\n};\n\n// Ensures polyfill operations are run sync.\nfunction flush () {\n  if (customElements && typeof customElements.flush === 'function') {\n    customElements.flush();\n  }\n}\n\n// Abstraction for browsers not following the spec.\nfunction matches (node, query) {\n  return (node.matches || node.msMatchesSelector).call(node, query);\n}\n\nclass Wrapper {\n  constructor (node, opts = {}) {\n    this.opts = opts;\n\n    const isStringNode = typeof node === 'string';\n    const isRootNode = !node.parentNode;\n\n    // If the fixture has been removed from the document, re-insert it.\n    if (!body.contains(fixture)) {\n      body.appendChild(fixture);\n    }\n\n    // If this is a new node, clean up the fixture.\n    // Add the node to the fixture so it runs the connectedCallback().\n    if (isRootNode) {\n      fixture.innerHTML = '';\n\n      if (isStringNode) {\n          fixture.innerHTML = node;\n          this.node = fixture.firstElementChild;\n      } else {\n          fixture.appendChild(node);\n          this.node = node;\n      }\n\n      const customElementDefinition = customElements.get(this.node.localName);\n      customElementDefinition && flush();\n    } else {\n      this.node = node;\n    }\n  }\n\n  get shadowRoot () {\n    const { node } = this;\n    return node.shadowRoot || node;\n  }\n\n  all (query) {\n    const { shadowRoot } = this;\n    let temp = [];\n\n    // Custom element constructors\n    if (query.prototype instanceof HTMLElement) {\n      this.walk(\n        shadowRoot,\n        node => node instanceof query,\n        node => temp.push(node)\n      );\n    // Custom filtering function\n    } else if (typeof query === 'function') {\n      this.walk(\n        shadowRoot,\n        query,\n        node => temp.push(node)\n      );\n    // Diffing node trees\n    //\n    // We have to check if the node type is an element rather than checking\n    // instanceof because the ShadyDOM polyfill seems to fail the prototype\n    // chain lookup.\n    } else if (query.nodeType === Node.ELEMENT_NODE) {\n      this.walk(\n        shadowRoot,\n        node => diff({ destination: query, source: node, root: true }).length === 0,\n        node => temp.push(node)\n      );\n    // Using an object as criteria\n    } else if (typeof query === 'object') {\n      const keys = Object.keys(query);\n      if (keys.length === 0) {\n        return temp;\n      }\n      this.walk(\n        shadowRoot,\n        node => keys.every(key => node[key] === query[key]),\n        node => temp.push(node)\n      );\n    // Selector\n    } else if (typeof query === 'string') {\n      this.walk(\n        shadowRoot,\n        node => matches(node, query),\n        node => temp.push(node),\n        { skip: true }\n      );\n    }\n\n    return temp.map(n => new Wrapper(n, this.opts));\n  }\n\n  has (query) {\n    return !!this.one(query);\n  }\n\n  one (query) {\n    return this.all(query)[0];\n  }\n\n  wait (func) {\n    return this.waitFor(wrap => !!wrap.node.shadowRoot).then(func);\n  }\n\n  waitFor (func, { delay } = { delay: 1 }) {\n    return new Promise((resolve, reject) => {\n      const check = () => {\n        const ret = (() => {\n          try {\n            return func(this);\n          } catch (e) {\n            reject(e);\n          }\n        })();\n        if (ret) {\n          resolve(this);\n        } else {\n          setTimeout(check, delay);\n        }\n      };\n      setTimeout(check, delay);\n    }).catch(e => {\n      throw e;\n    });\n  }\n\n  walk (node, query, callback, opts = { root: false, skip: false }) {\n    // The ShadyDOM polyfill creates a shadow root that is a <div /> but is an\n    // instanceof a DocumentFragment. For some reason a tree walker can't\n    // traverse it, so we must traverse each child. Due to this implementation\n    // detail, we must also tell the walker to include the root node, which it\n    // doesn't do with the default implementation.\n    if (node instanceof DocumentFragment) {\n      slice.call(node.children).forEach(child => {\n        this.walk(child, query, callback, {\n          root: true,\n          skip: opts.skip\n        });\n      });\n      return;\n    }\n\n    const acceptNode = node =>\n      query(node)\n        ? NodeFilter.FILTER_ACCEPT\n        : opts.skip ? NodeFilter.FILTER_SKIP : NodeFilter.FILTER_REJECT;\n\n    // IE requires a function, standards compliant browsers require an object.\n    acceptNode.acceptNode = acceptNode;\n\n    // Last argument here is for IE.\n    const tree = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT, acceptNode, true);\n\n    // Include the main node.\n    if (opts.root && query(node)) {\n      callback(node);\n    }\n\n    // Call user callback for each node.\n    while (tree.nextNode()) {\n      callback(tree.currentNode);\n    }\n  }\n}\n\nexport function mount (elem) {\n  return new Wrapper(elem);\n}\n"],"names":["window","DocumentFragment","Node","Promise","slice","startsWith","key","val","indexOf","shouldBeAttr","handleFunction","Fn","prototype","HTMLElement","h","name","attrs","node","document","createElement","keys","forEach","attr","setAttribute","chren","appendChild","child","createTextNode","customElements","NodeFilter","body","attachShadow","diff","require","default","enableFlush","fixture","call","mode","flush","matches","query","msMatchesSelector","Wrapper","opts","isStringNode","isRootNode","parentNode","contains","innerHTML","firstElementChild","customElementDefinition","get","localName","shadowRoot","temp","walk","push","nodeType","ELEMENT_NODE","destination","source","root","length","Object","every","skip","map","n","one","all","func","waitFor","wrap","then","delay","resolve","reject","check","ret","e","catch","callback","children","acceptNode","FILTER_ACCEPT","FILTER_SKIP","FILTER_REJECT","tree","createTreeWalker","SHOW_ELEMENT","nextNode","currentNode","mount","elem"],"mappings":"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"}